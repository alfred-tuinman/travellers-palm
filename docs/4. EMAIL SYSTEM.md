# Email Notification System

This application includes a comprehensive email notification system that automatically sends error alerts when 500 Internal Server Errors occur. The system is designed with security, reliability, and debugging utility in mind.

## Overview

The email notification system captures 500 errors in real-time and sends detailed error reports to administrators via Gmail SMTP. All sensitive information is automatically sanitized before being included in error reports.

## Features

### üö® **Automatic Error Detection**
- Monitors all HTTP 500 responses in real-time
- Captures exception details, stack traces, and request context
- Triggers immediate email notifications to administrators

### üîí **Security-First Design**
- **Credential Sanitization**: All OAuth2 tokens, API keys, passwords, and secrets are automatically redacted
- **Pattern Matching**: Advanced regex patterns detect and redact sensitive data in multiple formats
- **Template Security**: All data is sanitized before template rendering to prevent leakage

### üìß **Rich Error Details**
- **Request Context**: URL, method, IP address, user agent, timestamp
- **Exception Information**: Error messages, stack traces, file/line numbers
- **Response Analysis**: Intelligent extraction of useful info from HTML/compressed content
- **Clean Formatting**: HTML email template with proper UTF-8 encoding

### üõ†Ô∏è **Developer-Friendly**
- **Readable Content**: Automatically decompresses and extracts meaningful info from error pages
- **Truncated Output**: Long responses are intelligently summarized to keep emails manageable
- **Debug Information**: Includes all necessary context for effective troubleshooting

## Configuration

### Email Settings

Email configuration is handled through environment variables in `.env`:

```bash
# SMTP Configuration
EMAIL_HOST=smtp.gmail.com
EMAIL_PORT=587
EMAIL_TLS=1
EMAIL_USER=admin@odyssey.co.in
EMAIL_PASS=your_app_password_here

# OAuth2 Configuration (optional)
EMAIL_CLIENT_ID=your_client_id
EMAIL_CLIENT_SECRET=your_client_secret
EMAIL_REFRESH_TOKEN=your_refresh_token
```

### Application Configuration

Email settings in `config.yml`:

```yaml
email:
  error:
    from: 'system@travellerspalm.com'
    subject: '500 Error Notification'
```

## OAuth2 Authentication

For enhanced security, the application supports OAuth2 authentication using the `TravellersPalm::Mailer::OAuth2` module. This provides a more secure alternative to app passwords.

### OAuth2 Setup

1. **Google Cloud Console Setup**:
   - Create a project in Google Cloud Console
   - Enable Gmail API
   - Create OAuth2 credentials (Client ID and Client Secret)
   - Add your application's redirect URI

2. **Generate Refresh Token**:
   - Use the OAuth2 flow to obtain a refresh token
   - Store the refresh token securely

3. **Environment Configuration**:
   ```bash
   EMAIL_CLIENT_ID=your_google_client_id
   EMAIL_CLIENT_SECRET=your_google_client_secret
   EMAIL_REFRESH_TOKEN=your_refresh_token
   EMAIL_USER=admin@odyssey.co.in
   ```

### Using OAuth2 Mailer

#### Direct Email Sending
```perl
use TravellersPalm::Mailer::OAuth2;

my $mailer = TravellersPalm::Mailer::OAuth2->new(
    client_id     => $ENV{EMAIL_CLIENT_ID},
    client_secret => $ENV{EMAIL_CLIENT_SECRET}, 
    refresh_token => $ENV{EMAIL_REFRESH_TOKEN},
    email_user    => $ENV{EMAIL_USER},
);

$mailer->send_email(
    to      => 'user@example.com',
    subject => 'Subject',
    body    => 'Message body',
);
```

#### With Email::Stuffer Integration
```perl
use Email::Stuffer;

# Get transport from OAuth2 mailer
my $transport = $mailer->get_transport();

Email::Stuffer->from('admin@odyssey.co.in')
              ->to('recipient@example.com')
              ->subject('Test Message')
              ->text_body('Hello from OAuth2!')
              ->transport($transport)
              ->send;
```

#### Token Management
The OAuth2 module automatically handles:
- **Token Refresh**: Automatically refreshes access tokens when they expire
- **Token Caching**: Caches valid tokens to minimize API calls
- **Error Handling**: Graceful handling of authentication failures

### OAuth2 vs App Passwords

| Feature | OAuth2 | App Passwords |
|---------|--------|---------------|
| Security | Higher (token-based) | Lower (password-based) |
| Revocation | Granular control | Account-level only |
| Monitoring | Detailed API logs | Limited logging |
| Setup Complexity | Higher | Lower |
| Recommended For | Production | Development/Testing |

## How It Works

### 1. **Error Detection**
The system uses Mojolicious hooks to monitor HTTP responses:
- `after_dispatch` hook captures 500 status codes
- Exception data is extracted from multiple sources (stash, log history, etc.)

### 2. **Data Sanitization**
Before any email is sent, all data passes through comprehensive sanitization:

```perl
# Examples of what gets sanitized:
client_secret=abc123           ‚Üí client_secret=[REDACTED]
GOCSPX-xyz789                 ‚Üí GOCSPX-[REDACTED]
admin@odyssey.co.in           ‚Üí admin@[REDACTED]
tirp ansy vkxl ackl           ‚Üí [EMAIL_APP_PASSWORD_REDACTED]
1//0giZx3Siy5VXi...           ‚Üí 1//[OAUTH_REFRESH_TOKEN_REDACTED]
```

### 3. **Content Analysis**
The system intelligently processes response content:
- **Gzip Decompression**: Automatically decompresses gzipped responses
- **HTML Parsing**: Extracts titles, headings, and error messages from HTML
- **Binary Detection**: Identifies and summarizes binary content appropriately
- **Text Truncation**: Limits content length while preserving important information

### 4. **Email Delivery**
Uses Gmail SMTP with multiple authentication methods:
- **SASL Authentication**: Secure authentication using system SASL libraries
- **App Passwords**: Support for Gmail app-specific passwords
- **OAuth2 Support**: Optional OAuth2 authentication for enhanced security
- **Fallback Mechanisms**: Graceful degradation if advanced auth fails

## Email Template

Error emails include:

### **Header Information**
- Timestamp with timezone
- Host server information
- Request URL and HTTP method
- Client IP address and user agent

### **Error Details**
- Exception message and type
- Stack trace with file/line numbers
- Error categorization

### **Additional Information**
- Response body analysis (sanitized)
- Content type and encoding information
- Relevant context for debugging

## Security Features

### **Credential Protection**
- OAuth2 client secrets and IDs
- Email passwords and app passwords
- API keys and authentication tokens
- Long encoded strings (base64, JWT-like)
- Environment variable values

### **Pattern Matching**
The sanitization system uses advanced regex patterns to catch:
- Variable assignments (`password=value`)
- Descriptive text (`Testing with password: value`)
- Google-specific formats (`GOCSPX-xxx`, `client_id.apps.googleusercontent.com`)
- OAuth tokens (`1//refresh_token`, `4//auth_code`)

### **Multiple Sanitization Points**
- Exception messages
- Response body content
- Debug log entries
- Template variables
- URL parameters

## Development & Testing

### **Local Testing**
```bash
# Trigger a test error (sanitized for production)
curl http://localhost:3000/debug_500
```

### **Log Monitoring**
Error email activity is logged:
```bash
# Check email sending status
docker logs travellers_palm_app | grep "EMAIL SENT"

# Monitor sanitization activity
docker logs travellers_palm_app | grep "SANITIZATION"
```

### **SASL Dependencies**
The system handles complex SASL authentication requirements:
- Uses Docker-based workarounds for SASL installation
- Graceful fallback when SASL modules aren't available
- Detailed logging of authentication attempts

## Troubleshooting

### **Email Not Sending**
1. Check Gmail app password is correct
2. Verify SMTP configuration in `.env`
3. Check container logs for authentication errors
4. Ensure SASL modules are available

### **Missing Error Details**
1. Verify hooks are properly registered
2. Check template rendering in logs
3. Confirm error detection is triggering

### **Security Concerns**
1. Review sanitization patterns for new credential formats
2. Test error emails in development first
3. Rotate credentials if any leakage is suspected

## Files Involved

- `lib/TravellersPalm/Hooks.pm` - Main error detection and email logic
- `templates/mail/error_email.html.tt` - Email template
- `lib/TravellersPalm/Mailer.pm` - SMTP transport and authentication
- `config.yml` - Email configuration
- `.env` - SMTP credentials (keep secure!)

## Best Practices

1. **Regular Testing**: Periodically test error notifications in development
2. **Credential Rotation**: Rotate email credentials regularly
3. **Log Monitoring**: Monitor email sending success/failure rates
4. **Template Updates**: Keep error email templates informative but secure
5. **Access Control**: Limit access to admin email accounts receiving error notifications

## Security Notes

‚ö†Ô∏è **Important**: This system processes and emails sensitive error information. Always:
- Keep `.env` files secure and out of version control
- Use app-specific passwords rather than main account passwords
- Monitor who has access to error notification emails
- Regularly review and update sanitization patterns
- Test sanitization thoroughly when adding new credential types

The email notification system provides a robust foundation for production error monitoring while maintaining strict security standards.