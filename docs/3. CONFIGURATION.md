# Configuration Guide

This document covers all configuration aspects of the Travellers Palm application, from basic setup to advanced customization.

## üìã Table of Contents

- [Configuration Files](#configuration-files)
- [Environment Variables](#environment-variables)
- [Database Configuration](#database-configuration)
- [Email Configuration](#email-configuration)
- [Caching Configuration](#caching-configuration)
- [Logging Configuration](#logging-configuration)
- [Template Configuration](#template-configuration)
- [Security Settings](#security-settings)
- [Environment-Specific Config](#environment-specific-config)

## üìÑ Configuration Files

### Primary Configuration: `config.yml`

The main configuration file that controls all application behavior:

```yaml
# Application settings
app:
  name: "Travellers Palm"
  version: "1.0.0"
  debug: false
  secret: "your-secret-key-here"

# Database connections
databases:
  - "dbi:SQLite:dbname=data/main.db"
  - "dbi:SQLite:dbname=data/analytics.db"

# Template tokens (available in all templates)
template_tokens:
  site_name: "Travellers Palm"
  company_name: "Your Company"
  contact_email: "info@travellerspalm.com"
  google_analytics_id: "UA-XXXXXXXX-X"
  base_url: "https://travellerspalm.com"

# Email settings
email:
  error:
    from: 'system@travellerspalm.com'
    subject: '500 Error Notification'
    to: 'admin@travellerspalm.com'

# Caching
cache:
  memcached:
    servers: ["127.0.0.1:11211"]
    namespace: "tp_"
    expire_time: 3600

# Logging
logging:
  level: "info"
  file: "log/travellers_palm.log"
  max_size: "10MB"
  max_files: 5
```

### Environment Variables: `.env`

Sensitive configuration that shouldn't be in version control:

```bash
# Email SMTP Settings
EMAIL_HOST=smtp.gmail.com
EMAIL_PORT=587
EMAIL_TLS=1
EMAIL_USER=your-email@gmail.com
EMAIL_PASS=your-app-password

# OAuth2 Configuration (optional)
EMAIL_CLIENT_ID=your-client-id.apps.googleusercontent.com
EMAIL_CLIENT_SECRET=your-client-secret
EMAIL_REFRESH_TOKEN=your-refresh-token

# Application Secrets
APP_SECRET=your-application-secret-key
SESSION_SECRET=your-session-secret

# Database Configuration (if different from config.yml)
DB_PATH=data/main.db
TEST_DB_PATH=data/test.db

# External API Keys
WEATHER_API_KEY=your-weather-api-key
MAPS_API_KEY=your-google-maps-key

# Development Settings
MOJO_MODE=development
MOJO_LOG_LEVEL=info
```

## üóÑÔ∏è Database Configuration

### Database Initialization

Database setup is controlled by `lib/TravellersPalm/Database/Initializer.pm`:

```perl
# Seed version - increment to force database refresh
our $seed_version = "2025.11.01.002";

# Database configuration
my @databases = (
    {
        name => 'main',
        source => 'localdb/main.db',
        destination => 'data/main.db'
    },
    {
        name => 'analytics',
        source => 'localdb/analytics.db', 
        destination => 'data/analytics.db'
    }
);
```

### Connection Settings

```yaml
# config.yml
databases:
  # Primary database
  - "dbi:SQLite:dbname=data/main.db"
  
  # Additional databases
  - "dbi:SQLite:dbname=data/analytics.db"
  
  # MySQL example (if needed)
  # - "dbi:mysql:database=travellers_palm;host=localhost;port=3306"
  
  # PostgreSQL example (if needed)
  # - "dbi:Pg:dbname=travellers_palm;host=localhost;port=5432"
```

### Database Environment Variables

```bash
# Override database paths
DB_MAIN_PATH=data/main.db
DB_ANALYTICS_PATH=data/analytics.db

# MySQL connection (if used)
DB_MYSQL_HOST=localhost
DB_MYSQL_PORT=3306
DB_MYSQL_NAME=travellers_palm
DB_MYSQL_USER=username
DB_MYSQL_PASS=password

# Connection pool settings
DB_MAX_CONNECTIONS=10
DB_TIMEOUT=30
```

## üìß Email Configuration

### SMTP Settings

```yaml
# config.yml
email:
  error:
    from: 'system@travellerspalm.com'
    subject: '500 Error Notification'
    to: 'admin@travellerspalm.com'
  
  contact:
    from: 'noreply@travellerspalm.com'
    reply_to: 'support@travellerspalm.com'
    subject_prefix: '[Travellers Palm] '
```

### Gmail Configuration

For Gmail SMTP, use app-specific passwords:

```bash
# .env
EMAIL_HOST=smtp.gmail.com
EMAIL_PORT=587
EMAIL_TLS=1
EMAIL_USER=your-email@gmail.com
EMAIL_PASS=your-16-char-app-password

# Optional: OAuth2 for enhanced security
EMAIL_CLIENT_ID=your-id.apps.googleusercontent.com
EMAIL_CLIENT_SECRET=GOCSPX-your-client-secret
EMAIL_REFRESH_TOKEN=1//your-refresh-token
```

### Email Templates

Template configuration for different email types:

```yaml
# config.yml
email:
  templates:
    error: 'mail/error_email.html.tt'
    contact: 'mail/contact_form.html.tt'
    booking: 'mail/booking_confirmation.html.tt'
    newsletter: 'mail/newsletter.html.tt'
```

## üöÄ Caching Configuration

### Memcached Setup

```yaml
# config.yml
cache:
  memcached:
    servers: 
      - "127.0.0.1:11211"
      - "cache2.example.com:11211"  # Additional server
    namespace: "tp_"
    expire_time: 3600  # Default expiration (1 hour)
    connect_timeout: 1
    io_timeout: 2.5
    
  # Cache keys configuration
  keys:
    destinations: "dest_{country}_{type}"
    hotels: "hotels_{destination_id}"
    user_sessions: "session_{user_id}"
```

### Cache Environment Variables

```bash
# .env
MEMCACHED_SERVERS=127.0.0.1:11211,cache2.example.com:11211
MEMCACHED_NAMESPACE=tp_production_
CACHE_DEFAULT_EXPIRE=3600

# Disable caching for development
CACHE_ENABLED=false
```

### In-Memory Fallback

```yaml
# config.yml - when Memcached unavailable
cache:
  fallback: "memory"
  memory:
    max_entries: 1000
    expire_time: 1800  # 30 minutes
```

## üìù Logging Configuration

### Log Levels and Files

```yaml
# config.yml
logging:
  level: "info"  # debug, info, warn, error, fatal
  file: "log/travellers_palm.log"
  
  # Log rotation
  max_size: "10MB"
  max_files: 5
  
  # Additional loggers
  access_log: "log/access.log"
  error_log: "log/error.log"
  email_log: "log/email.log"
  
  # Format
  format: "[%date] [%level] [%pid] %message"
```

### Environment-Based Logging

```bash
# .env
MOJO_LOG_LEVEL=debug  # Override config.yml for development
LOG_PATH=log/
LOG_EMAIL_NOTIFICATIONS=true

# Production logging
LOG_SYSLOG=true
LOG_JSON_FORMAT=true
```

### Custom Log Categories

```perl
# In application code
$app->log->debug("Database query: $sql");
$app->log->info("User login: $username");
$app->log->warn("Cache miss for key: $key");
$app->log->error("Payment processing failed: $error");
$app->log->fatal("Database connection lost");

# Email-specific logging
$app->log->info("EMAIL SENT: Error notification to $recipient");
$app->log->error("EMAIL FAILED: SMTP connection timeout");
```

## üé® Template Configuration

### Template Tokens

Global variables available in all templates:

```yaml
# config.yml
template_tokens:
  # Site information
  site_name: "Travellers Palm"
  company_name: "Your Travel Company"
  tagline: "Your Journey Begins Here"
  
  # Contact information
  contact_email: "info@travellerspalm.com"
  contact_phone: "+1-555-123-4567"
  support_email: "support@travellerspalm.com"
  
  # Social media
  facebook_url: "https://facebook.com/travellerspalm"
  twitter_handle: "@travellerspalm"
  instagram_url: "https://instagram.com/travellerspalm"
  
  # Analytics and tracking
  google_analytics_id: "UA-XXXXXXXX-X"
  google_maps_key: "your-maps-api-key"
  facebook_pixel_id: "your-pixel-id"
  
  # URLs and paths
  base_url: "https://travellerspalm.com"
  cdn_url: "https://cdn.travellerspalm.com"
  image_path: "/images"
  asset_path: "/assets"
  
  # Feature flags
  enable_booking: true
  enable_reviews: true
  enable_newsletter: true
  maintenance_mode: false
```

### Template Paths

```yaml
# config.yml
templates:
  paths:
    - "templates"
    - "templates/mobile"  # Mobile-specific templates
    - "templates/admin"   # Admin interface templates
  
  # Template processing
  compile_templates: true  # Pre-compile for production
  cache_templates: true
  template_cache_size: 100
```

## üîí Security Settings

### Application Security

```yaml
# config.yml
security:
  secret_key: "your-very-long-secret-key-here"
  session:
    name: "travellers_palm_session"
    secure: true      # HTTPS only in production
    httponly: true    # No JavaScript access
    samesite: "strict"
    expires: 86400    # 24 hours
  
  # CSRF protection
  csrf:
    enabled: true
    field_name: "_csrf_token"
    cookie_name: "csrf_token"
  
  # Rate limiting
  rate_limit:
    requests_per_minute: 60
    requests_per_hour: 1000
```

### Content Security Policy

```yaml
# config.yml
security:
  csp:
    default_src: "'self'"
    script_src: "'self' 'unsafe-inline' https://www.google-analytics.com"
    style_src: "'self' 'unsafe-inline' https://fonts.googleapis.com"
    img_src: "'self' data: https:"
    font_src: "'self' https://fonts.gstatic.com"
    connect_src: "'self'"
```

### Security Environment Variables

```bash
# .env
APP_SECRET=your-super-secret-application-key-minimum-32-chars
SESSION_SECRET=your-session-signing-secret
CSRF_SECRET=your-csrf-protection-secret

# Production security
FORCE_HTTPS=true
HSTS_MAX_AGE=31536000
SECURE_COOKIES=true

# API security
API_RATE_LIMIT=1000
API_KEY_REQUIRED=true
```

## üåç Environment-Specific Configuration

### Development (`development.yml`)

```yaml
# Inherit from main config and override
extends: "config.yml"

app:
  debug: true
  
logging:
  level: "debug"
  
cache:
  enabled: false  # Disable caching for development
  
email:
  send_emails: false  # Don't send real emails
  debug_email: "dev@localhost"
  
templates:
  auto_reload: true
  cache_templates: false
```

### Testing (`testing.yml`)

```yaml
extends: "config.yml"

databases:
  - "dbi:SQLite:dbname=data/test.db"
  
logging:
  level: "error"  # Quiet during tests
  file: "log/test.log"
  
email:
  send_emails: false
  
cache:
  enabled: false
```

### Production (`production.yml`)

```yaml
extends: "config.yml"

app:
  debug: false
  
logging:
  level: "warn"
  format: "json"  # Structured logging
  
cache:
  enabled: true
  
security:
  session:
    secure: true
    
email:
  send_emails: true
  rate_limit: 100  # Emails per hour
```

## üîß Configuration Loading

### Environment Detection

The application automatically loads configuration based on the `MOJO_MODE` environment variable:

```bash
# Development (default)
MOJO_MODE=development

# Testing
MOJO_MODE=testing

# Production
MOJO_MODE=production
```

### Configuration Validation

Add validation to ensure required settings are present:

```perl
# In startup
sub validate_config {
    my $app = shift;
    my $config = $app->config;
    
    # Required settings
    die "Missing app secret" unless $config->{app}{secret};
    die "No databases configured" unless $config->{databases};
    die "Email configuration missing" unless $config->{email};
    
    # Validate email settings if sending enabled
    if ($config->{email}{send_emails}) {
        die "SMTP host required" unless $ENV{EMAIL_HOST};
        die "SMTP credentials required" unless $ENV{EMAIL_USER} && $ENV{EMAIL_PASS};
    }
}
```

## üìö Configuration Examples

### Complete Development Setup

```bash
# .env.development
MOJO_MODE=development
MOJO_LOG_LEVEL=debug

EMAIL_HOST=smtp.gmail.com
EMAIL_PORT=587
EMAIL_TLS=1
EMAIL_USER=dev@travellerspalm.com
EMAIL_PASS=dev-app-password

APP_SECRET=development-secret-key-not-for-production
SESSION_SECRET=dev-session-secret

CACHE_ENABLED=false
SEND_EMAILS=false
```

### Production Configuration

```bash
# .env.production
MOJO_MODE=production
MOJO_LOG_LEVEL=warn

EMAIL_HOST=smtp.gmail.com
EMAIL_PORT=587
EMAIL_TLS=1
EMAIL_USER=admin@travellerspalm.com
EMAIL_PASS=secure-app-password-here

APP_SECRET=very-long-secure-production-secret-key-minimum-32-characters
SESSION_SECRET=production-session-signing-secret

CACHE_ENABLED=true
MEMCACHED_SERVERS=cache1.internal:11211,cache2.internal:11211

FORCE_HTTPS=true
SECURE_COOKIES=true
```

## üîç Configuration Troubleshooting

### Debug Configuration Loading

```perl
# Add to startup for debugging
$app->log->debug("Loaded config: " . Dumper($app->config));
$app->log->debug("Environment: " . $app->mode);
$app->log->debug("Email settings: " . Dumper($app->config->{email}));
```

### Common Issues

#### Email Not Sending
- Check `EMAIL_HOST`, `EMAIL_PORT`, `EMAIL_USER`, `EMAIL_PASS`
- Verify app password is correct (not account password)
- Check firewall/network access to SMTP server

#### Cache Not Working
- Verify Memcached is running: `telnet 127.0.0.1 11211`
- Check `CACHE_ENABLED` setting
- Review cache configuration in config.yml

#### Database Issues
- Verify database files exist in `data/` directory
- Check `databases` configuration in config.yml
- Ensure write permissions on `data/` directory

#### Template Errors
- Check `template_tokens` configuration
- Verify template files exist in `templates/` directory
- Review Template Toolkit syntax in .tt files

This configuration guide provides the foundation for customizing Travellers Palm to your specific needs. For additional help, see the [Getting Started](GETTING_STARTED.md) and [Development](DEVELOPMENT.md) guides.